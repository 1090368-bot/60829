<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貪食蛇遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Google 字體 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: none; /* 防止在移動設備上滑動時滾動頁面 */
        }
        canvas {
            background-image:
                linear-gradient(45deg, #2d3748 25%, transparent 25%),
                linear-gradient(-45deg, #2d3748 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #2d3748 75%),
                linear-gradient(-45deg, transparent 75%, #2d3748 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-4 text-emerald-400">貪食蛇遊戲</h1>

        <!-- 遊戲資訊 -->
        <div class="flex justify-between items-center mb-4 px-2">
            <div class="text-lg">
                <span>分數: </span>
                <span id="score" class="font-bold text-yellow-400">0</span>
            </div>
            <div class="text-lg">
                <span>最高分: </span>
                <span id="high-score" class="font-bold text-cyan-400">0</span>
            </div>
        </div>

        <!-- 遊戲畫布 -->
        <div class="relative">
            <canvas id="gameCanvas" width="400" height="400" class="bg-gray-800 rounded-lg shadow-2xl mx-auto block"></canvas>
            
            <!-- 遊戲結束畫面 -->
            <div id="gameOverScreen" class="absolute inset-0 bg-black bg-opacity-70 flex-col items-center justify-center rounded-lg hidden">
                <h2 class="text-4xl font-bold text-red-500 mb-4">遊戲結束</h2>
                <p class="text-xl mb-4">你的分數: <span id="finalScore">0</span></p>
                
                <!-- Gemini Feature Section -->
                <div id="gemini-feature" class="text-center mb-4 h-24">
                    <button id="geminiButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-400">
                        ✨ 為這次表現取個綽號
                    </button>
                    <div id="geminiResponse" class="mt-4 text-lg text-yellow-300 h-10 flex items-center justify-center px-4"></div>
                    <div id="loadingIndicator" class="hidden mt-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto"></div>
                        <p>正在產生中...</p>
                    </div>
                </div>

                <button id="restartButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-emerald-400">
                    重新開始
                </button>
            </div>
        </div>

        <!-- 手機端控制器 -->
        <div class="mt-6 flex justify-center md:hidden">
            <div class="grid grid-cols-3 gap-4 w-48">
                <div></div>
                <button id="up-btn" class="bg-gray-700 p-4 rounded-lg text-xl">↑</button>
                <div></div>
                <button id="left-btn" class="bg-gray-700 p-4 rounded-lg text-xl">←</button>
                <button id="down-btn" class="bg-gray-700 p-4 rounded-lg text-xl">↓</button>
                <button id="right-btn" class="bg-gray-700 p-4 rounded-lg text-xl">→</button>
            </div>
        </div>
    </div>

    <script>
        // DOM 元素獲取
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('high-score');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const restartButton = document.getElementById('restartButton');
        const geminiButton = document.getElementById('geminiButton');
        const geminiResponse = document.getElementById('geminiResponse');
        const loadingIndicator = document.getElementById('loadingIndicator');


        // 遊戲參數設定
        const gridSize = 20; // 每個格子的寬度
        const canvasSize = canvas.width;
        let snake, food, dx, dy, score, highScore, changingDirection, gameLoop;
        
        // 從 localStorage 讀取最高分
        highScore = localStorage.getItem('snakeHighScore') || 0;
        highScoreElement.textContent = highScore;

        // 初始化遊戲狀態
        function initializeGame() {
            // 蛇的初始狀態 (身體由多個部分組成)
            snake = [
                { x: 10 * gridSize, y: 10 * gridSize }, // 蛇頭
                { x: 9 * gridSize, y: 10 * gridSize },
                { x: 8 * gridSize, y: 10 * gridSize }
            ];
            // 初始移動方向 (向右)
            dx = gridSize;
            dy = 0;
            score = 0;
            scoreElement.textContent = score;
            changingDirection = false;
            gameOverScreen.style.display = 'none';
            generateFood();
        }
        
        // 主遊戲循環
        function main() {
            if (didGameEnd()) {
                showGameOver();
                return;
            }

            // 用於防止快速連續改變方向導致的 bug
            changingDirection = false;
            
            // 使用 setTimeout 創建循環，可控制遊戲速度
            gameLoop = setTimeout(function onTick() {
                clearCanvas();
                drawFood();
                moveSnake();
                drawSnake();
                main();
            }, 150);
        }

        // 開始新遊戲
        function startGame() {
            if (gameLoop) clearTimeout(gameLoop);
            initializeGame();
            main();
        }

        // 清空畫布
        function clearCanvas() {
            ctx.fillStyle = '#1a202c'; // 背景色
            ctx.fillRect(0, 0, canvasSize, canvasSize);
        }

        // 繪製蛇
        function drawSnake() {
            snake.forEach((segment, index) => {
                // 蛇頭使用不同顏色
                ctx.fillStyle = index === 0 ? '#48bb78' : '#38a169';
                ctx.strokeStyle = '#1a202c';
                ctx.fillRect(segment.x, segment.y, gridSize, gridSize);
                ctx.strokeRect(segment.x, segment.y, gridSize, gridSize);
            });
        }
        
        // 繪製食物
        function drawFood() {
            ctx.fillStyle = '#f56565'; // 食物顏色
            ctx.strokeStyle = '#1a202c';
            ctx.fillRect(food.x, food.y, gridSize, gridSize);
            ctx.strokeRect(food.x, food.y, gridSize, gridSize);
        }

        // 移動蛇
        function moveSnake() {
            // 根據目前方向創建新的蛇頭
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            snake.unshift(head); // 將新蛇頭加到陣列最前面

            // 檢查是否吃到食物
            const didEatFood = snake[0].x === food.x && snake[0].y === food.y;
            if (didEatFood) {
                score += 10;
                scoreElement.textContent = score;
                // 如果吃到食物，就重新生成食物，蛇的身體會變長 (因為沒有移除尾巴)
                generateFood();
            } else {
                // 如果沒吃到食物，就移除蛇的尾巴，保持長度不變
                snake.pop();
            }
        }
        
        // 隨機生成食物
        function generateFood() {
            // 隨機產生食物的 x, y 座標
            food = {
                x: Math.floor(Math.random() * (canvasSize / gridSize)) * gridSize,
                y: Math.floor(Math.random() * (canvasSize / gridSize)) * gridSize
            };
            // 確保食物不會生成在蛇的身體上
            snake.forEach(function isFoodOnSnake(segment) {
                if (segment.x === food.x && segment.y === food.y) {
                    generateFood();
                }
            });
        }

        // 改變方向
        function changeDirection(event) {
            // 防止在一次移動中多次改變方向
            if (changingDirection) return;
            changingDirection = true;

            const keyPressed = event.keyCode;
            const goingUp = dy === -gridSize;
            const goingDown = dy === gridSize;
            const goingRight = dx === gridSize;
            const goingLeft = dx === -gridSize;
            
            // 37: 左, 38: 上, 39: 右, 40: 下
            if (keyPressed === 37 && !goingRight) {
                dx = -gridSize;
                dy = 0;
            } else if (keyPressed === 38 && !goingDown) {
                dx = 0;
                dy = -gridSize;
            } else if (keyPressed === 39 && !goingLeft) {
                dx = gridSize;
                dy = 0;
            } else if (keyPressed === 40 && !goingUp) {
                dx = 0;
                dy = gridSize;
            }
        }

        // 檢查遊戲是否結束 (撞牆或撞到自己)
        function didGameEnd() {
            // 檢查是否撞到自己
            for (let i = 4; i < snake.length; i++) {
                if (snake[i].x === snake[0].x && snake[i].y === snake[0].y) return true;
            }
            // 檢查是否撞牆
            const hitLeftWall = snake[0].x < 0;
            const hitRightWall = snake[0].x > canvasSize - gridSize;
            const hitTopWall = snake[0].y < 0;
            const hitBottomWall = snake[0].y > canvasSize - gridSize;

            return hitLeftWall || hitRightWall || hitTopWall || hitBottomWall;
        }
        
        // Gemini API 呼叫函數
        async function generateNickname() {
            loadingIndicator.style.display = 'block';
            geminiResponse.textContent = '';
            geminiButton.disabled = true;
            geminiButton.style.display = 'none';

            const apiKey = ""; // API 金鑰將由環境提供
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const userPrompt = `我剛剛玩了一場貪食蛇遊戲，得到了 ${score} 分。請根據這個分數，給我一個簡短、有趣、有創意的稱號或一句話的評語。風格要輕鬆幽默。用繁體中文回答。`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
            };

            try {
                // 使用指數退避策略進行重試
                let response;
                let retries = 3;
                let delay = 1000;
                while (retries > 0) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        retries--;
                    } else {
                        break;
                    }
                }


                if (!response.ok) {
                    throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text;

                if (text) {
                    geminiResponse.textContent = `「${text.trim()}」`;
                } else {
                    geminiResponse.textContent = '無法產生稱號，請再試一次。';
                }

            } catch (error) {
                console.error('Gemini API 呼叫錯誤:', error);
                geminiResponse.textContent = '哎呀，發生錯誤了！';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }


        // 顯示遊戲結束畫面
        function showGameOver() {
            clearTimeout(gameLoop);
            gameOverScreen.style.display = 'flex';
            finalScoreElement.textContent = score;

            // 重設 Gemini 功能
            geminiResponse.textContent = '';
            geminiButton.style.display = 'block';
            geminiButton.disabled = false;
            loadingIndicator.style.display = 'none';

            if (score > highScore) {
                highScore = score;
                highScoreElement.textContent = highScore;
                localStorage.setItem('snakeHighScore', highScore);
            }
        }

        // 事件監聽
        document.addEventListener('keydown', changeDirection);
        restartButton.addEventListener('click', startGame);
        geminiButton.addEventListener('click', generateNickname);

        // 手機端控制器事件
        document.getElementById('up-btn').addEventListener('click', () => changeDirection({ keyCode: 38 }));
        document.getElementById('down-btn').addEventListener('click', () => changeDirection({ keyCode: 40 }));
        document.getElementById('left-btn').addEventListener('click', () => changeDirection({ keyCode: 37 }));
        document.getElementById('right-btn').addEventListener('click', () => changeDirection({ keyCode: 39 }));


        // 遊戲開始
        startGame();
    </script>
</body>
</html>

